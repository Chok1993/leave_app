import streamlit as st
import pandas as pd
import datetime as dt
import altair as alt
import matplotlib.pyplot as plt
from fpdf import FPDF
import tempfile
import base64
import io

# ===== à¹„à¸Ÿà¸¥à¹Œà¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ =====
FILE_SCAN = "scan_report.xlsx"
FILE_REPORT = "leave_report.xlsx"

# ===== à¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œ =====
try:
    df_scan = pd.read_excel(FILE_SCAN)
except:
    df_scan = pd.DataFrame()

try:
    df_report = pd.read_excel(FILE_REPORT)
except:
    df_report = pd.DataFrame()

# ===== à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™ =====
staff_groups = [
    "à¸à¸¥à¸¸à¹ˆà¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¸£à¸°à¸šà¸²à¸”à¸§à¸´à¸—à¸¢à¸²à¹à¸¥à¸°à¸•à¸­à¸šà¹‚à¸•à¹‰à¸ à¸²à¸§à¸°à¸‰à¸¸à¸à¹€à¸‰à¸´à¸™à¸—à¸²à¸‡à¸ªà¸²à¸˜à¸²à¸£à¸“à¸ªà¸¸à¸‚",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¸žà¸±à¸’à¸™à¸²à¸­à¸‡à¸„à¹Œà¸à¸£",
    "à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­à¸™à¸³à¹‚à¸”à¸¢à¹à¸¡à¸¥à¸‡à¸—à¸µà¹ˆ 9.1 à¸ˆ.à¸Šà¸±à¸¢à¸ à¸¹à¸¡à¸´",
    "à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­à¸™à¸³à¹‚à¸”à¸¢à¹à¸¡à¸¥à¸‡à¸—à¸µà¹ˆ 9.2 à¸ˆ.à¸šà¸¸à¸£à¸µà¸£à¸±à¸¡à¸¢à¹Œ",
    "à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­à¸™à¸³à¹‚à¸”à¸¢à¹à¸¡à¸¥à¸‡à¸—à¸µà¹ˆ 9.3 à¸ˆ.à¸ªà¸¸à¸£à¸´à¸™à¸—à¸£à¹Œ",
    "à¸¨à¸¹à¸™à¸¢à¹Œà¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­à¸™à¸³à¹‚à¸”à¸¢à¹à¸¡à¸¥à¸‡à¸—à¸µà¹ˆ 9.4 à¸›à¸²à¸à¸Šà¹ˆà¸­à¸‡",
    "à¸”à¹ˆà¸²à¸™à¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¸žà¸£à¸¡à¹à¸”à¸™à¸Šà¹ˆà¸­à¸‡à¸ˆà¸­à¸¡ à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸ªà¸¸à¸£à¸´à¸™à¸—à¸£à¹Œ",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¹‚à¸£à¸„à¹„à¸¡à¹ˆà¸•à¸´à¸”à¸•à¹ˆà¸­",
    "à¸‡à¸²à¸™à¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„à¹€à¸‚à¸•à¹€à¸¡à¸·à¸­à¸‡",
    "à¸‡à¸²à¸™à¸à¸Žà¸«à¸¡à¸²à¸¢",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¹‚à¸£à¸„à¸•à¸´à¸”à¸•à¹ˆà¸­à¹€à¸£à¸·à¹‰à¸­à¸£à¸±à¸‡",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¸«à¹‰à¸­à¸‡à¸›à¸à¸´à¸šà¸±à¸•à¸´à¸à¸²à¸£à¸—à¸²à¸‡à¸à¸²à¸£à¹à¸žà¸—à¸¢à¹Œà¸”à¹‰à¸²à¸™à¸„à¸§à¸šà¸„à¸¸à¸¡à¹‚à¸£à¸„",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¸ªà¸·à¹ˆà¸­à¸ªà¸²à¸£à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¹ˆà¸¢à¸‡à¹‚à¸£à¸„à¹à¸¥à¸°à¸ à¸±à¸¢à¸ªà¸¸à¸‚à¸ à¸²à¸ž",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¹‚à¸£à¸„à¸ˆà¸²à¸à¸à¸²à¸£à¸›à¸£à¸°à¸à¸­à¸šà¸­à¸²à¸Šà¸µà¸žà¹à¸¥à¸°à¸ªà¸´à¹ˆà¸‡à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡",
    "à¸¨à¸¹à¸™à¸¢à¹Œà¸šà¸£à¸´à¸à¸²à¸£à¹€à¸§à¸Šà¸¨à¸²à¸ªà¸•à¸£à¹Œà¸›à¹‰à¸­à¸‡à¸à¸±à¸™",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¸šà¸£à¸´à¸«à¸²à¸£à¸—à¸±à¹ˆà¸§à¹„à¸›",
    "à¸¨à¸¹à¸™à¸¢à¹Œà¸à¸¶à¸à¸­à¸šà¸£à¸¡à¸™à¸±à¸à¸£à¸°à¸šà¸²à¸”à¸§à¸´à¸—à¸¢à¸²à¸ à¸²à¸„à¸ªà¸™à¸²à¸¡",
    "à¸à¸¥à¸¸à¹ˆà¸¡à¸žà¸±à¸’à¸™à¸²à¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¹à¸¥à¸°à¸§à¸´à¸ˆà¸±à¸¢"
]

# ===== à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹à¸­à¸”à¸¡à¸´à¸™ =====
ADMIN_PASSWORD = "DDC9admin"

# ===== à¹€à¸¡à¸™à¸¹à¸«à¸¥à¸±à¸ =====
st.title("ðŸ“‹ à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (à¸ªà¸„à¸£.9)")
main_menu = st.sidebar.radio("à¹€à¸¥à¸·à¸­à¸à¸«à¸™à¹‰à¸²à¹€à¸¡à¸™à¸¹", ["ðŸ“Š Dashboard à¸£à¸§à¸¡", "ðŸ§­ à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£", "ðŸ•’ à¸à¸²à¸£à¸¥à¸²", "ðŸ› ï¸ à¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥à¸£à¸°à¸šà¸š (Admin)"])

# ===============================================================
# ====================== DASHBOARD à¸£à¸§à¸¡ ===========================
# ===============================================================
if main_menu == "ðŸ“Š Dashboard à¸£à¸§à¸¡":
    st.header("ðŸ“ˆ Dashboard à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”")

    total_travel = len(df_scan)
    total_leave = len(df_report)
    total_travel_days = df_scan["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™"].sum() if "à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™" in df_scan.columns else 0
    total_leave_days = df_report["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"].sum() if "à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²" in df_report.columns else 0

    col1, col2 = st.columns(2)
    col1.metric("à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£", f"{total_travel} à¸„à¸™")
    col1.metric("à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£à¸£à¸§à¸¡", f"{total_travel_days} à¸§à¸±à¸™")
    col2.metric("à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¸¥à¸²", f"{total_leave} à¸„à¸™")
    col2.metric("à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²à¸£à¸§à¸¡", f"{total_leave_days} à¸§à¸±à¸™")

    if not df_report.empty:
        st.subheader("ðŸ§¾ Key Metrics à¸à¸²à¸£à¸¥à¸²")
        unique_persons = df_report["à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥"].nunique()
        avg_leave = round(df_report["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"].mean(), 2)
        c1, c2 = st.columns(2)
        c1.metric("à¸ˆà¸³à¸™à¸§à¸™à¸šà¸¸à¸„à¸¥à¸²à¸à¸£à¸—à¸µà¹ˆà¸¥à¸²", f"{unique_persons} à¸„à¸™")
        c2.metric("à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸§à¸±à¸™à¸¥à¸²à¸•à¹ˆà¸­à¸„à¸™", f"{avg_leave} à¸§à¸±à¸™")

        st.markdown("### ðŸ“Š à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²à¸•à¸²à¸¡à¸›à¸£à¸°à¹€à¸ à¸—")
        leave_by_type = df_report.groupby("à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"].sum().reset_index()
        st.bar_chart(leave_by_type.set_index("à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²"))

        st.markdown("### ðŸ¢ à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")
        leave_by_group = df_report.groupby("à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"].sum().reset_index()
        st.bar_chart(leave_by_group.set_index("à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™"))

        st.markdown("### ðŸ“‹ à¸•à¸²à¸£à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸² (à¸”à¸´à¸š)")
        st.dataframe(df_report.astype(str), use_container_width=True)

# ===============================================================
# =================== à¸Ÿà¸­à¸£à¹Œà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£ ===================
# ===============================================================
elif main_menu == "ðŸ§­ à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£":
    st.header("ðŸ§¾ à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£")
    with st.form("scan_form"):
        data = {}
        data["à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥"] = st.text_input("ðŸ‘¤ à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥")
        data["à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™"] = st.selectbox("ðŸ¢ à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™", staff_groups)
        data["à¸›à¸µ à¸ž.à¸¨."] = st.number_input("ðŸ“… à¸›à¸µ à¸ž.à¸¨.", min_value=2560, max_value=2600, value=2568)
        data["à¸à¸´à¸ˆà¸à¸£à¸£à¸¡"] = st.text_input("ðŸ¢ à¸à¸´à¸ˆà¸à¸£à¸£à¸¡ (à¸žà¸´à¸¡à¸žà¹Œà¸Šà¸·à¹ˆà¸­à¸à¸´à¸ˆà¸à¸£à¸£à¸¡)")
        data["à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ"] = st.text_input("ðŸ“ à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ")
        data["à¸œà¸¹à¹‰à¸ˆà¸±à¸”"] = st.text_input("ðŸ‘¥ à¸œà¸¹à¹‰à¸ˆà¸±à¸”")
        data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡"] = st.date_input("ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡", dt.date.today())
        data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”"] = st.date_input("ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”", dt.date.today())
        data["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™"] = (data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”"] - data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡"]).days + 1
        st.write(f"ðŸ“† à¸£à¸§à¸¡ {data['à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™']} à¸§à¸±à¸™")

        st.markdown("### ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¹€à¸”à¸´à¸™à¸—à¸²à¸‡ (à¸«à¸²à¸à¹„à¸›à¹€à¸›à¹‡à¸™à¸«à¸¡à¸¹à¹ˆà¸„à¸“à¸°)")
        num_people = st.number_input("à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¹€à¸”à¸´à¸™à¸—à¸²à¸‡", min_value=0, max_value=20, step=1)
        companions = []
        for i in range(int(num_people)):
            name = st.text_input(f"à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸„à¸™à¸—à¸µà¹ˆ {i+1}")
            group = st.selectbox(f"à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¸„à¸™à¸—à¸µà¹ˆ {i+1}", staff_groups, key=f"group_{i}")
            if name:
                companions.append({"à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥": name, "à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™": group})
        data["à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¹€à¸”à¸´à¸™à¸—à¸²à¸‡"] = ", ".join([p["à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥"] for p in companions])
        data["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"] = st.text_area("ðŸ“ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸")

        submitted = st.form_submit_button("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥")

    if submitted:
        if not data["à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥"]:
            st.error("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­-à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£")
        elif not data["à¸à¸´à¸ˆà¸à¸£à¸£à¸¡"]:
            st.error("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸à¸´à¸ˆà¸à¸£à¸£à¸¡")
        elif int(num_people) > 0 and len(companions) < int(num_people):
            st.error("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸£à¹ˆà¸§à¸¡à¹€à¸”à¸´à¸™à¸—à¸²à¸‡à¹ƒà¸«à¹‰à¸„à¸£à¸š")
        else:
            df_scan = df_scan.dropna(how='all')
            df_scan = pd.concat([df_scan, pd.DataFrame([data])], ignore_index=True)
            df_scan.to_excel(FILE_SCAN, index=False)
            st.success("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢")

    if not df_scan.empty:
        st.markdown("## ðŸ“Š à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£")
        st.write(f"ðŸ“‹ à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” {len(df_scan)} à¸£à¸²à¸¢à¸à¸²à¸£ à¸£à¸§à¸¡ {df_scan['à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™'].sum()} à¸§à¸±à¸™")
        st.dataframe(df_scan.astype(str), use_container_width=True)

# ===============================================================
# =================== à¸Ÿà¸­à¸£à¹Œà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸¥à¸² ==========================
# ===============================================================
elif main_menu == "ðŸ•’ à¸à¸²à¸£à¸¥à¸²":
    st.header("ðŸ“ à¹à¸šà¸šà¸Ÿà¸­à¸£à¹Œà¸¡à¸šà¸±à¸™à¸—à¸¶à¸à¸à¸²à¸£à¸¥à¸²")
    with st.form("leave_form"):
        data = {}
        data["à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥"] = st.text_input("ðŸ‘¤ à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥")
        data["à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™"] = st.selectbox("ðŸ¢ à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™", staff_groups)
        data["à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²"] = st.selectbox("ðŸ“Œ à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²", ["à¸¥à¸²à¸›à¹ˆà¸§à¸¢", "à¸¥à¸²à¸à¸´à¸ˆ", "à¸¥à¸²à¸žà¸±à¸à¸œà¹ˆà¸­à¸™", "à¸­à¸·à¹ˆà¸™à¹†"])
        data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡"] = st.date_input("ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡", dt.date.today())
        data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”"] = st.date_input("ðŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”", dt.date.today())
        data["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"] = (data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”"] - data["à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡"]).days + 1
        st.write(f"ðŸ—“ï¸ à¸£à¸§à¸¡à¸¥à¸² {data['à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²']} à¸§à¸±à¸™")
        data["à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸"] = st.text_area("ðŸ“ à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸")

        submitted = st.form_submit_button("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥")

    if submitted:
        if not data["à¸Šà¸·à¹ˆà¸­-à¸ªà¸à¸¸à¸¥"]:
            st.error("âš ï¸ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­-à¸™à¸²à¸¡à¸ªà¸à¸¸à¸¥à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¸¥à¸²")
        else:
            df_report = df_report.dropna(how='all')
            df_report = pd.concat([df_report, pd.DataFrame([data])], ignore_index=True)
            df_report.to_excel(FILE_REPORT, index=False)
            st.success("âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢")

    if not df_report.empty:
        st.markdown("## ðŸ“Š à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸²")
        st.write(f"ðŸ“‹ à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” {len(df_report)} à¸£à¸²à¸¢à¸à¸²à¸£ à¸£à¸§à¸¡à¸¥à¸² {df_report['à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²'].sum()} à¸§à¸±à¸™")
        st.dataframe(df_report.astype(str), use_container_width=True)

# ------------------ ADMIN ------------------
elif menu == "ðŸ‘©â€ðŸ’¼ Admin":
    import matplotlib.pyplot as plt
    from fpdf import FPDF
    import tempfile

    st.header("ðŸ” à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸œà¸¹à¹‰à¸”à¸¹à¹à¸¥")
    password = st.text_input("à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™", type="password")

    if password == ADMIN_PASSWORD:
        st.success("âœ… à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆ")

        tab1, tab2, tab3 = st.tabs(["ðŸ§­ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£", "ðŸ•’ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸²", "ðŸ“ˆ Dashboard à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™"])

        # ========== à¹à¸—à¹‡à¸š 1: à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£ ==========
        with tab1:
            st.markdown("### ðŸ§­ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”")
            st.dataframe(df_scan.astype(str), use_container_width=True)

        # ========== à¹à¸—à¹‡à¸š 2: à¸à¸²à¸£à¸¥à¸² ==========
        with tab2:
            st.markdown("### ðŸ•’ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸²à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”")
            st.dataframe(df_report.astype(str), use_container_width=True)

        # ========== à¹à¸—à¹‡à¸š 3: Dashboard à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™ ==========
        with tab3:
            st.markdown("### ðŸ“ˆ Dashboard à¸ªà¸£à¸¸à¸›à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")

            # ====== à¸•à¸±à¸§à¸à¸£à¸­à¸‡à¸›à¸µà¹à¸¥à¸°à¹€à¸”à¸·à¸­à¸™ ======
            this_year = dt.date.today().year + 543
            year_choice = st.selectbox("à¹€à¸¥à¸·à¸­à¸à¸›à¸µ à¸ž.à¸¨.", list(range(this_year - 3, this_year + 1)), index=3)
            month_choice = st.selectbox("à¹€à¸¥à¸·à¸­à¸à¹€à¸”à¸·à¸­à¸™", list(range(1, 13)), format_func=lambda x: f"à¹€à¸”à¸·à¸­à¸™ {x}")

            # ====== à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ ======
            def filter_data_by_month(df, start_col, end_col):
                df = df.copy()
                df[start_col] = pd.to_datetime(df[start_col], errors="coerce")
                df[end_col] = pd.to_datetime(df[end_col], errors="coerce")
                df["à¸›à¸µ"] = df[start_col].dt.year + 543
                df["à¹€à¸”à¸·à¸­à¸™"] = df[start_col].dt.month
                return df[(df["à¸›à¸µ"] == year_choice) & (df["à¹€à¸”à¸·à¸­à¸™"] == month_choice)]

            df_scan_filtered = filter_data_by_month(df_scan, "à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡", "à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”") if not df_scan.empty else pd.DataFrame()
            df_report_filtered = filter_data_by_month(df_report, "à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡", "à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”") if not df_report.empty else pd.DataFrame()

            col1, col2 = st.columns(2)

            # --- à¸à¸£à¸²à¸Ÿà¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£ ---
            fig1, fig2, fig3 = None, None, None
            if not df_scan_filtered.empty:
                travel_group = df_scan_filtered.groupby("à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™"].sum().sort_values(ascending=False).head(5)
                col1.subheader(f"ðŸ§­ Top 5 à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™à¸—à¸µà¹ˆà¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸” ({month_choice}/{year_choice})")
                col1.bar_chart(travel_group)
                fig1 = travel_group.plot(kind="bar", color="skyblue", figsize=(5, 3), title="Top 5 à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£").get_figure()
            else:
                col1.info("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£à¹ƒà¸™à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸")

            # --- à¸à¸£à¸²à¸Ÿà¸à¸²à¸£à¸¥à¸² ---
            if not df_report_filtered.empty:
                leave_group = df_report_filtered.groupby("à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"].sum().sort_values(ascending=False).head(5)
                col2.subheader(f"ðŸ•’ Top 5 à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™à¸—à¸µà¹ˆà¸¥à¸²à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸” ({month_choice}/{year_choice})")
                col2.bar_chart(leave_group)
                fig2 = leave_group.plot(kind="bar", color="salmon", figsize=(5, 3), title="Top 5 à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™à¸¥à¸²").get_figure()
            else:
                col2.info("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸²à¹ƒà¸™à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸")

            # ===== à¸à¸£à¸²à¸Ÿà¸§à¸‡à¸à¸¥à¸¡à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸² =====
            st.markdown("### ðŸ¥§ à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²")
            if not df_report_filtered.empty and "à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²" in df_report_filtered.columns:
                leave_type = df_report_filtered.groupby("à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"].sum()
                if not leave_type.empty:
                    fig3, ax = plt.subplots(figsize=(5, 5))
                    ax.pie(leave_type, labels=leave_type.index, autopct="%1.1f%%", startangle=90)
                    ax.set_title("à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²")
                    st.pyplot(fig3)
                else:
                    st.info("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸²à¸£à¸¥à¸²à¹ƒà¸™à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰")
            else:
                st.info("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¸¥à¸²à¹ƒà¸™à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸")

            # ===== à¸•à¸²à¸£à¸²à¸‡à¸ªà¸£à¸¸à¸›à¸£à¸§à¸¡ =====
            st.markdown("### ðŸ“‹ à¸•à¸²à¸£à¸²à¸‡à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸£à¸§à¸¡à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")
            summary = None
            if not df_scan_filtered.empty or not df_report_filtered.empty:
                travel_sum = (
                    df_scan_filtered.groupby("à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™"]
                    .sum()
                    .reset_index()
                    .rename(columns={"à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™": "à¸£à¸§à¸¡à¸§à¸±à¸™à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£"})
                )
                leave_sum = (
                    df_report_filtered.groupby("à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™")["à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²"]
                    .sum()
                    .reset_index()
                    .rename(columns={"à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸¥à¸²": "à¸£à¸§à¸¡à¸§à¸±à¸™à¸¥à¸²"})
                )
                summary = pd.merge(travel_sum, leave_sum, on="à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™", how="outer").fillna(0)
                summary["à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”"] = summary["à¸£à¸§à¸¡à¸§à¸±à¸™à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£"] + summary["à¸£à¸§à¸¡à¸§à¸±à¸™à¸¥à¸²"]
                st.dataframe(summary.sort_values("à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”", ascending=False), use_container_width=True)
            else:
                st.info("à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸£à¸¸à¸›")

            # ===== à¸›à¸¸à¹ˆà¸¡à¸ªà¸£à¹‰à¸²à¸‡ PDF =====
            st.markdown("### ðŸ–¨ï¸ à¸žà¸´à¸¡à¸žà¹Œà¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸› (PDF)")
            if st.button("ðŸ“„ à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸²à¸¢à¸‡à¸²à¸™ PDF"):
                pdf = FPDF()
                pdf.add_page()
                pdf.add_font('THSarabun', '', 'THSarabunNew.ttf', uni=True)
                pdf.set_font('THSarabun', '', 16)
                pdf.cell(0, 10, f"à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£à¸¥à¸²à¹à¸¥à¸°à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£ à¹€à¸”à¸·à¸­à¸™ {month_choice} à¸›à¸µ {year_choice}", ln=True, align="C")
                pdf.ln(10)

                # à¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œà¸à¸£à¸²à¸Ÿà¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§
                temp_dir = tempfile.gettempdir()
                if fig1:
                    path1 = f"{temp_dir}/travel_chart.png"
                    fig1.savefig(path1)
                    pdf.image(path1, w=170)
                if fig2:
                    path2 = f"{temp_dir}/leave_chart.png"
                    fig2.savefig(path2)
                    pdf.image(path2, w=170)
                if fig3:
                    path3 = f"{temp_dir}/pie_chart.png"
                    fig3.savefig(path3)
                    pdf.image(path3, w=150)

                if summary is not None:
                    pdf.ln(10)
                    pdf.set_font('THSarabun', '', 14)
                    pdf.cell(0, 10, "à¸•à¸²à¸£à¸²à¸‡à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸£à¸§à¸¡ (à¸§à¸±à¸™)", ln=True)
                    pdf.ln(5)
                    for _, row in summary.iterrows():
                        pdf.cell(0, 8, f"{row['à¸à¸¥à¸¸à¹ˆà¸¡à¸‡à¸²à¸™']} - à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£ {int(row['à¸£à¸§à¸¡à¸§à¸±à¸™à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£'])} / à¸¥à¸² {int(row['à¸£à¸§à¸¡à¸§à¸±à¸™à¸¥à¸²'])} / à¸£à¸§à¸¡ {int(row['à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”'])}", ln=True)

                # à¸ªà¹ˆà¸‡à¸­à¸­à¸ PDF
                pdf_output = f"{temp_dir}/summary_{year_choice}_{month_choice}.pdf"
                pdf.output(pdf_output)
                with open(pdf_output, "rb") as f:
                    st.download_button(
                        label="ðŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™ PDF",
                        data=f,
                        file_name=f"à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›_à¸ªà¸„à¸£9_{year_choice}_{month_choice}.pdf",
                        mime="application/pdf"
                    )

            # ===== à¸›à¸¸à¹ˆà¸¡à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™ Excel =====
            st.markdown("### ðŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (Excel)")
            def to_excel(download_scan, download_leave):
                from io import BytesIO
                output = BytesIO()
                with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
                    download_scan.to_excel(writer, sheet_name="à¸à¸²à¸£à¹„à¸›à¸£à¸²à¸Šà¸à¸²à¸£", index=False)
                    download_leave.to_excel(writer, sheet_name="à¸à¸²à¸£à¸¥à¸²", index=False)
                return output.getvalue()

            excel_data = to_excel(df_scan, df_report)
            st.download_button(
                label="ðŸ“¥ à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ªà¸£à¸¸à¸›à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (Excel)",
                data=excel_data,
                file_name=f"à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸‡à¸²à¸™_à¸ªà¸„à¸£9_{dt.date.today()}.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

    elif password:
        st.error("âŒ à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ")
